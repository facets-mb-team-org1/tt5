Some changes

Some code changes

Fix tests